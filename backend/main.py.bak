from fastapi import FastAPI, Request, File, UploadFile, Form, HTTPException
from fastapi.responses import JSONResponse, FileResponse
from fastapi.middleware.cors import CORSMiddleware
from pydantic import BaseModel
from typing import Optional, List
import pandas as pd
import numpy as np
import os
import json
import pickle
import matplotlib.pyplot as plt
import seaborn as sns
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import LabelEncoder, StandardScaler
import requests
import io
import base64
from datetime import datetime
import random
import math

app = FastAPI(title="Tarımsal Karar Destek Sistemi API")

# CORS ayarları
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # Tüm kaynaklara izin ver (geliştirme için, üretimde daha kısıtlayıcı olmalı)
    allow_credentials=True,
    allow_methods=["*"],  # Tüm HTTP metodlarına izin ver
    allow_headers=["*"],  # Tüm başlıklara izin ver
)

# Veri klasörü oluştur
os.makedirs("data", exist_ok=True)
os.makedirs("models", exist_ok=True)
os.makedirs("reports", exist_ok=True)

# Veri setlerini yükle
try:
    crop_data = pd.read_csv("Crop_recommendation.csv")
    fertilizer_data = pd.read_csv("fertilizer_recommendation_dataset.csv")
    pest_data = pd.read_csv("pest_infestation.csv")
    print("Veri setleri başarıyla yüklendi.")
except Exception as e:
    print(f"Veri setleri yüklenirken hata oluştu: {e}")
    # Dummy veri oluştur
    crop_data = pd.DataFrame()
    fertilizer_data = pd.DataFrame()
    pest_data = pd.DataFrame()

# Model sınıfları
class PredictRequest(BaseModel):
    latitude: float
    longitude: float
    temperature: float
    humidity: float
    rainfall: float
    ph: float
    N: float
    P: float
    K: float
    soil_type: str
    crop_type: str
    fertilizer_type: str
    pest_count: int

class PredictResponse(BaseModel):
    probability: float
    result: str
    message: str
    recommendations: Optional[List[str]] = None
    chart_url: Optional[str] = None

class WeatherRequest(BaseModel):
    latitude: float
    longitude: float

# Model eğitimi ve kaydı
def train_crop_model():
    if crop_data.empty:
        return None
    
    # Basit bir model eğitimi
    X = crop_data[['N', 'P', 'K', 'temperature', 'humidity', 'ph', 'rainfall']]
    y = crop_data['label']
    
    # Label encoding
    le = LabelEncoder()
    y_encoded = le.fit_transform(y)
    
    # Model eğitimi
    model = RandomForestClassifier(n_estimators=100, random_state=42)
    model.fit(X, y_encoded)
    
    # Modeli kaydet
    with open('models/crop_model.pkl', 'wb') as f:
        pickle.dump((model, le), f)
    
    return model, le

# Modeli yükle veya eğit
def load_or_train_model():
    try:
        with open('models/crop_model.pkl', 'rb') as f:
            model, le = pickle.load(f)
        return model, le
    except:
        return train_crop_model()

# Hava durumu API
def get_weather_data(lat, lon):
    try:
        # OpenWeatherMap API kullanımı
        api_key = "YOUR_API_KEY"  # OpenWeatherMap'ten alacağınız API anahtarını buraya yazın
        url = f"https://api.openweathermap.org/data/2.5/weather?lat={lat}&lon={lon}&appid={api_key}&units=metric&lang=tr"
        
        response = requests.get(url)
        if response.status_code == 200:
            data = response.json()
            
            # API'den gelen verileri düzenle
            weather_data = {
                "main": {
                    "temp": data["main"]["temp"],
                    "humidity": data["main"]["humidity"]
                },
                "wind": {
                    "speed": data["wind"]["speed"]
                },
                "rain": {
                    "1h": data.get("rain", {}).get("1h", 0)
                }
            }
            return weather_data
        else:
            print(f"Hava durumu API hatası: {response.status_code}")
            # API hatası durumunda yedek veri kullan
            return get_fallback_weather_data(lat, lon)
    except Exception as e:
        print(f"Hava durumu verisi alınırken hata: {e}")
        # Hata durumunda yedek veri kullan
        return get_fallback_weather_data(lat, lon)

# Yedek hava durumu verisi (API çalışmadığında)
def get_fallback_weather_data(lat, lon):
    # Türkiye'nin gerçek hava durumu ortalamaları (mevsime göre)
    current_month = datetime.now().month
    
    # Mevsime göre ortalama sıcaklıklar (yaklaşık değerler)
    if 3 <= current_month <= 5:  # İlkbahar
        temp_range = (15, 25)
        humidity_range = (50, 70)
        rain_chance = 0.4
    elif 6 <= current_month <= 8:  # Yaz
        temp_range = (25, 35)
        humidity_range = (40, 60)
        rain_chance = 0.2
    elif 9 <= current_month <= 11:  # Sonbahar
        temp_range = (10, 20)
        humidity_range = (60, 80)
        rain_chance = 0.5
    else:  # Kış
        temp_range = (0, 10)
        humidity_range = (70, 90)
        rain_chance = 0.6
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Mevsim ortalamalarına göre değerler
    temp = random.uniform(temp_range[0], temp_range[1])
    humidity = random.randint(humidity_range[0], humidity_range[1])
    wind_speed = random.uniform(2.0, 8.0)
    
    rain_amount = 0
    if random.random() < rain_chance:
        rain_amount = random.uniform(0.1, 5.0)
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
# Grafik oluşturma fonksiyonu
def create_chart(data):
    plt.figure(figsize=(10, 6))
    
    # Veri hazırlama
    categories = ['Sıcaklık', 'Nem', 'Yağış', 'pH', 'Azot', 'Fosfor', 'Potasyum']
    values = [data['temperature'], data['humidity'], data['rainfall'], 
              data['ph'], data['N'], data['P'], data['K']]
    
    # Renk paleti
    colors = ['#2ecc71', '#3498db', '#9b59b6', '#e74c3c', '#f39c12', '#1abc9c', '#d35400']
    
    # Çubuk grafik
    plt.bar(categories, values, color=colors, width=0.6)
    plt.title('Tarımsal Parametreler', fontsize=16)
    plt.ylabel('Değerler', fontsize=12)
    plt.grid(axis='y', linestyle='--', alpha=0.7)
    
    # Değerleri çubukların üzerine yaz
    for i, v in enumerate(values):
        plt.text(i, v + 0.5, str(round(v, 2)), ha='center', fontsize=10)
    
    # Grafik dosyasını kaydet
    img_buf = io.BytesIO()
    plt.savefig(img_buf, format='png', bbox_inches='tight')
    img_buf.seek(0)
    
    # Base64 formatına dönüştür
    img_base64 = base64.b64encode(img_buf.read()).decode('utf-8')
    plt.close()
    
    return f"data:image/png;base64,{img_base64}"
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 30.0)  # 15-30 derece arası
    humidity = random.randint(40, 80)  # %40-80 arası nem
    wind_speed = random.uniform(2.0, 8.0)  # 2-8 m/s rüzgar hızı
    rain_chance = random.random()  # 0-1 arası yağmur olasılığı
    
    rain_amount = 0
    if rain_chance > 0.7:  # %30 olasılıkla yağmur
        rain_amount = random.uniform(0.1, 5.0)  # 0.1-5mm arası yağış
    
    return {
        "main": {
            "temp": round(temp, 1),
            "humidity": humidity
        },
        "wind": {
            "speed": round(wind_speed, 1)
        },
        "rain": {
            "1h": round(rain_amount, 1)
        }
    }
    
    # Konum bazlı dummy hava durumu verisi
    import random
    import math
    
    # Konuma göre seed oluştur (aynı konum için aynı veri dönsün)
    random.seed(int(math.floor(lat * 100) + math.floor(lon * 100)))
    
    # Türkiye'nin farklı bölgeleri için farklı hava durumu verileri
    temp = random.uniform(15.0, 3)